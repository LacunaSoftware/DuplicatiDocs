<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://backup.e-notariado.org.br/appendix-b-how-the-restore-process-works/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Como o processo de restauração funciona - Manual do Módulo Agente do Backup e-notariado</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <link href="../css/version-select.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-XXXXXXXX-X', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">Manual do Módulo Agente do Backup e-notariado</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Manual <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../01-introduction/">Introdução</a>
</li>
                                    
<li >
    <a href="../02-installation/">Instalação</a>
</li>
                                    
<li >
    <a href="../03-using-the-graphical-user-interface/">Usando a Interface Gráfica de Usuário</a>
</li>
                                    
<li >
    <a href="../04-using-duplicati-from-the-command-line/">Usando o Módulo Agente pela linha de comando</a>
</li>
                                    
<li >
    <a href="../05-storage-providers/">Provedores de Armazenamento</a>
</li>
                                    
<li >
    <a href="../06-advanced-options/">Opções Avançadas</a>
</li>
                                    
<li >
    <a href="../07-other-command-line-utilities/">Outras utilidades da linha de comando</a>
</li>
                                    
<li >
    <a href="../08-disaster-recovery/">Recuperação após desastres</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Artigos <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../appendix-a-how-the-backup-process-works/">Como o processo de backup funciona</a>
</li>
                                    
<li class="active">
    <a href="./">Como o processo de restauração funciona</a>
</li>
                                    
<li >
    <a href="../appendix-c-choosing-sizes-in-duplicati/">Escolhendo tamanhos corretos</a>
</li>
                                    
<li >
    <a href="../appendix-d-filters/">Filtros</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../appendix-f-license-agreement/">Licença</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../appendix-a-how-the-backup-process-works/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../appendix-c-choosing-sizes-in-duplicati/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#how-the-restore-process-works">How the restore process works</a></li>
            <li><a href="#duplicati-restore-process">Duplicati restore process</a></li>
            <li><a href="#the-example-files">The example files</a></li>
            <li><a href="#getting-the-initial-list">Getting the initial list</a></li>
            <li><a href="#expanding-blocklists">Expanding blocklists</a></li>
            <li><a href="#restoring-small-files">Restoring small files</a></li>
            <li><a href="#restoring-large-files">Restoring large files</a></li>
            <li><a href="#verification-of-the-restored-files">Verification of the restored files</a></li>
            <li><a href="#building-a-local-index">Building a local index</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="how-the-restore-process-works">How the restore process works<a class="headerlink" href="#how-the-restore-process-works" title="Permanent link">&para;</a></h1>
<h3 id="duplicati-restore-process">Duplicati restore process<a class="headerlink" href="#duplicati-restore-process" title="Permanent link">&para;</a></h3>
<p>If you have read the How the backup process works document, you might be wondering how the restore process uses the stored data to restore your files. This document explains this process, using the <code>Duplicati.CommandLine.RecoveryTool.exe</code> process as the starting point, so we can skip the complications added by the local database. Unless you are curious about the inner workings of Duplicati, you do not need to read this document, you can simply use the normal restore process, or the recovery tool.</p>
<h3 id="the-example-files">The example files<a class="headerlink" href="#the-example-files" title="Permanent link">&para;</a></h3>
<p>For this document we continue with the example from the backup document, and walk through the restore process.</p>
<p>From the initial backup, we saw that the directory structure that was backed up looks like this:</p>
<div class="codehilite"><pre><span></span>C:\data
|----&gt; mydoc.txt, 4kb
|----&gt; myvideo.mp4, 210kb
|----&gt; extra
       |-----&gt; olddoc.txt, 2kb
       |-----&gt; samevideo.mp4, 210kb
</pre></div>


<p>To simplify matters, we will not use a local database, and we only look at file data, not metadata and not directories.</p>
<h3 id="getting-the-initial-list">Getting the initial list<a class="headerlink" href="#getting-the-initial-list" title="Permanent link">&para;</a></h3>
<p>To start with, we need to pick the <code>dlist</code> file that contains the version of the files that we want. In a real-world example, you can observe the names of the <code>dlist</code> files, which have a timestamp embedded in them. The timestamps are stored in UTC, so you may need to adjust to your local timezone.</p>
<p>For this example we only have a single <code>dlist</code> file, so we pick that one, download it and see the contents:</p>
<div class="codehilite"><pre><span></span>[
  {
  &quot;type&quot;: &quot;Folder&quot;,
  &quot;path&quot;: &quot;C:\\data\\&quot;
  },
  {
  &quot;type&quot;: &quot;File&quot;,
  &quot;path&quot;: &quot;C:\\data\\mydoc.txt&quot;,
  &quot;size&quot;: 4096,
  &quot;hash&quot;: &quot;qaFXpxVTuYCuibb9P41VSeVn4pIaK8o3jUpJKqI4VF4=&quot;
  },
  {
  &quot;type&quot;: &quot;File&quot;,
  &quot;path&quot;: &quot;C:\\data\\myvideo.mp4&quot;,
  &quot;size&quot;: 215040,
  &quot;hash&quot;: &quot;4sGwVN/QuWHD+yVI10qgYa4e2F5M4zXLKBQaf1rtTCs=&quot;,
  &quot;blocklists&quot;: [ &quot;Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA=&quot; ]
  },
  {
  &quot;type&quot;: &quot;Folder&quot;,
  &quot;path&quot;: &quot;C:\\data\\extra&quot;
  },
  {
  &quot;type&quot;: &quot;File&quot;,
  &quot;path&quot;: &quot;C:\\data\\extra\\olddoc.txt&quot;,
  &quot;size&quot;: 2048,
  &quot;hash&quot;: &quot;R/XSNsb4ln/SkeJwFDd4Fv4OnW2QNIxMR4HItgg9qCE=&quot;
  },
  {
  &quot;type&quot;: &quot;File&quot;,
  &quot;path&quot;: &quot;C:\\data\\extra\\samevideo.mp4&quot;,
  &quot;size&quot;: 215040,
  &quot;hash&quot;: &quot;4sGwVN/QuWHD+yVI10qgYa4e2F5M4zXLKBQaf1rtTCs=&quot;,
  &quot;blocklists&quot;: [ &quot;Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA=&quot; ]
  },
]
</pre></div>


<p>From this we can see that there are 4 files we need to restore. We can also see that there are files that need "blocklists".</p>
<h3 id="expanding-blocklists">Expanding blocklists<a class="headerlink" href="#expanding-blocklists" title="Permanent link">&para;</a></h3>
<p>As explained in the How the Backup Process Works document, the blocklists are data blocks that contain additional hashes needed to restore the files. Thus we start by "expanding" the blocklists into a list of hashes that we need.</p>
<p>As the two files share the blocklist has <code>Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA=</code>, we only need to get this block to complete the expansion phase.</p>
<p>Unfortunately, there is no correlation between the names of the <code>dblock</code> files and the data they contain, so we need to download all of them, until we find the data we need. Since this is slow in a real-world scenario, Duplicati replicates this information in the <code>dindex</code> files, which are much smaller than the <code>dblock</code> files.</p>
<p>Assuming we have the same <code>dblock</code> file as mentioned in the backup document, we get a zip file with these files:</p>
<div class="codehilite"><pre><span></span>qaFXpxVTuYCuibb9P41VSeVn4pIaK8o3jUpJKqI4VF4= (4kb)
0td8NEaS7SMrQc5Gs0Sdxjb/1MXEEuwkyxRpguDiWsY= (100kb)
PN2oO6eQudCRSdx3zgk6SJvlI5BquP6djt5hG4ZfRCQ= (100kb)
uS/2KMSmm2IWlZ77JiHH1p/yp7Cvhr8CKmRHJNMRqwA= (10kb)
Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA= (96b)
R/XSNsb4ln/SkeJwFDd4Fv4OnW2QNIxMR4HItgg9qCE= (2kb)
</pre></div>


<p>Here we see that the file <code>Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA=</code> is 96 bytes, and we know that a sha256 is 32 bytes. We can then compute that this chunk of data expands to <code>96/32 = 3</code> hashes. We could also compute this size, by looking at the size of the file, and then find out how many 100kb blocks it spans.</p>
<p>For efficiency, the hashes are stored in raw binary format, but here we can represent them as base64 encoded strings:</p>
<div class="codehilite"><pre><span></span>0td8NEaS7SMrQc5Gs0Sdxjb/1MXEEuwkyxRpguDiWsY=
PN2oO6eQudCRSdx3zgk6SJvlI5BquP6djt5hG4ZfRCQ=
uS/2KMSmm2IWlZ77JiHH1p/yp7Cvhr8CKmRHJNMRqwA=
</pre></div>


<p>We can now expand <code>Uo1f4rVjNRX10HkxQxXauCrRv0wJOvStqt9gaUT0uPA=</code> into the three real hashes, and we now have an expanded list of hashes for each file we need to restore.</p>
<h3 id="restoring-small-files">Restoring small files<a class="headerlink" href="#restoring-small-files" title="Permanent link">&para;</a></h3>
<p>Restoring the small files is simple: extract the contents and put them into a file with that name. The process is then to locate the <code>dblock</code> file that contains the block we need, and extracting it. In Duplicati, this is improved with <code>dindex</code> files, that contains a map showing which blocks can be found in a <code>dblock</code> file, such that a download can be avoided.</p>
<h3 id="restoring-large-files">Restoring large files<a class="headerlink" href="#restoring-large-files" title="Permanent link">&para;</a></h3>
<p>As we have expanded the list of hashes, we follow the same process as for the small files, and simply locate blocks, one at a time. If we restore the blocks in the order specified, each block will represent the correct length (100kb), and we can simply extract the files from the zip archive, and append it to the file. Since we use a fixed size block, we can also choose to restore out-of-order, by computing the file offset for each block before inserting the data.</p>
<h3 id="verification-of-the-restored-files">Verification of the restored files<a class="headerlink" href="#verification-of-the-restored-files" title="Permanent link">&para;</a></h3>
<p>As we saw in the file list contents, each file also has a <code>hash</code> property, which we can use after the restore process to verify that each file is restored correctly.</p>
<h3 id="building-a-local-index">Building a local index<a class="headerlink" href="#building-a-local-index" title="Permanent link">&para;</a></h3>
<p>For the <code>Duplicati.CommandLine.RecoveryTool.exe</code> the above process is followed as described, but with an two additional steps: download and index.</p>
<p>The download process, merely downloads (and decrypts) all the dblock files it can find on the remote storage, such that all the following operations can be done with local files.</p>
<p>Since the recovery tool does not rely on <code>dindex</code> files, it would be extremely slow if it had to open all zip files to check if they contain the block it wants to process. The index process speeds this up significantly, by producing a plain text file, where each line presents a (block, zip archive) pair.</p>
<p>The index step then opens each <code>dblock</code> file, and lists the contents, and outputs a line for each data block it finds. After each <code>dblock</code> file has been processed, the file is sorted alphabetically.</p>
<p>There are more efficient ways to store this data, but the text file allows an expert user to monitor, update and adjust the index file with a simple text editor, should something go wrong. An expert user can also investigate the <code>dlist</code> file, and use the index file to figure out where a particular block is.</p>
<p>For the final phase in the recovery tool, restore, the sorted index is used to locate the <code>dblock</code> file. This search relies on the alphabetic sorting to ensure that lookup times does not grow linearly when the number of data blocks.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../js/version-select.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
